<?php
// inc/functions.php
// Reusable helpers used across the project.
// Keep minimal dependencies (only uses $pdo where DB access is needed).

if (session_status() === PHP_SESSION_NONE) session_start();

// Escape helper used in templates
if (!function_exists('e')) {
    function e($s) {
        return htmlspecialchars($s ?? '', ENT_QUOTES | ENT_SUBSTITUTE, 'UTF-8');
    }
}

// Simple int getter
if (!function_exists('get_int')) {
    function get_int($k, $default=0) {
        return isset($_GET[$k]) ? intval($_GET[$k]) : $default;
    }
}

// Pagination helper (simple)
if (!function_exists('paginate_params')) {
    function paginate_params($total, $per_page, $current_page, $base_url) {
        $pages = max(1, (int)ceil($total / $per_page));
        $current_page = max(1, min($pages, (int)$current_page));
        return [
            'pages' => $pages,
            'current' => $current_page,
            'prev' => $current_page > 1 ? $current_page - 1 : null,
            'next' => $current_page < $pages ? $current_page + 1 : null,
            'base_url' => $base_url
        ];
    }
}

// --- Flash messages (one-time) ---
if (!function_exists('flash_set')) {
    function flash_set($type, $msg) {
        if (session_status() === PHP_SESSION_NONE) session_start();
        if (!isset($_SESSION['flash_messages']) || !is_array($_SESSION['flash_messages'])) {
            $_SESSION['flash_messages'] = [];
        }
        $_SESSION['flash_messages'][] = ['type' => $type, 'msg' => $msg];
    }
}

if (!function_exists('flash_render')) {
    function flash_render() {
        if (session_status() === PHP_SESSION_NONE) session_start();
        if (!empty($_SESSION['flash_messages']) && is_array($_SESSION['flash_messages'])) {
            foreach ($_SESSION['flash_messages'] as $f) {
                $t = $f['type'] ?? 'info';
                $msg = isset($f['msg']) ? e($f['msg']) : '';
                $class = ($t === 'success') ? 'flash-msg success' : (($t === 'error') ? 'flash-msg error' : 'flash-msg info');
                echo '<div class="'. $class .'">' . $msg . "</div>\n";
            }
            unset($_SESSION['flash_messages']);
        }
    }
}

// csrf_field helper (if your inc/csrf.php defines csrf_token())
if (!function_exists('csrf_field')) {
    if (function_exists('csrf_token')) {
        function csrf_field() {
            $t = csrf_token();
            return '<input type="hidden" name="csrf_token" value="'.htmlspecialchars($t, ENT_QUOTES).'">';
        }
    } else {
        function csrf_field() { return ''; }
    }
}

// Current user helpers (depend on session)
if (!function_exists('current_user_id')) {
    function current_user_id() {
        return isset($_SESSION['user_id']) ? intval($_SESSION['user_id']) : 0;
    }
}

if (!function_exists('current_user_role')) {
    function current_user_role() {
        return isset($_SESSION['role']) ? $_SESSION['role'] : null;
    }
}

// Enforce role-based access, redirect when unauthorized
if (!function_exists('require_role')) {
    function require_role($role) {
        if (session_status() === PHP_SESSION_NONE) session_start();
        if (empty($_SESSION['role']) || $_SESSION['role'] !== $role) {
            // simple redirect to role select or login
            header("Location: /doctor-appointment/role-select.php");
            exit;
        }
    }
}

// Notification creator (uses global $pdo)
if (!function_exists('create_notification')) {
    function create_notification($user_id, $title, $message) {
        global $pdo;
        if (!isset($pdo)) return false;
        $stmt = $pdo->prepare("INSERT INTO notifications (user_id, title, message, is_read, created_at) VALUES (?, ?, ?, 0, NOW())");
        return $stmt->execute([$user_id, $title, $message]);
    }
}

// Simple logger into logs table
if (!function_exists('create_log')) {
    function create_log($actor_id, $actor_role, $event_type, $detail='') {
        global $pdo;
        if (!isset($pdo)) return false;
        $stmt = $pdo->prepare("INSERT INTO logs (actor_id, actor_role, event_type, detail, created_at) VALUES (?, ?, ?, ?, NOW())");
        return $stmt->execute([$actor_id, $actor_role, $event_type, $detail]);
    }
}

// Utility: safe redirect helper
if (!function_exists('redirect_to')) {
    function redirect_to($url) {
        header("Location: ".$url);
        exit;
    }
}
